<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Firestore Analytics Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        colors: {
          primary: { light: '#06b6d4', DEFAULT: '#0891b2', dark: '#0e7490' }
        },
        fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
      },
    },
  }
</script>
<style>
  .fade-slide { animation: fadeSlide 0.5s ease forwards; }
  @keyframes fadeSlide { from {opacity:0; transform: translateY(10px);} to {opacity:1; transform: translateY(0);} }

  tbody tr { transition: background 0.3s, transform 0.2s; cursor: pointer; }
  tbody tr:hover { background-color: rgba(14,165,233,0.1); transform: translateX(2px); }

  ::-webkit-scrollbar { width:6px; height:6px; }
  ::-webkit-scrollbar-thumb { background:rgba(148,163,184,0.6); border-radius:9999px; }

  td { max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  td:hover { white-space: normal; overflow: visible; }

  .glass {
    backdrop-filter: blur(16px) saturate(180%);
    background-color: rgba(255,255,255,0.75);
  }
  html.dark .glass {
    background-color: rgba(30,41,59,0.6);
  }
</style>
</head>

<body class="bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-900 dark:to-slate-950 min-h-screen font-sans text-gray-800 dark:text-gray-100 transition-colors duration-500 flex flex-col items-center">

<!-- HEADER -->
<header class="w-full max-w-7xl mt-8 mb-8 flex flex-col md:flex-row justify-between items-start md:items-center px-6 fade-slide">
  <h1 class="text-4xl font-extrabold bg-gradient-to-r from-cyan-500 to-blue-600 bg-clip-text text-transparent tracking-tight">
    Firestore Analytics Dashboard
  </h1>
  <div class="flex gap-3 items-center mt-4 md:mt-0">
    <button id="toggleDark"
      class="px-4 py-2 bg-gradient-to-r from-cyan-600 to-indigo-600 hover:from-cyan-500 hover:to-indigo-500 text-white rounded-lg font-semibold shadow transition">
      Toggle Dark
    </button>
    <div id="errorMessage" class="hidden bg-red-100 dark:bg-red-800 text-red-700 dark:text-red-200 px-4 py-2 rounded shadow text-sm transition-all"></div>
  </div>
</header>

<!-- CONTROLS -->
<section class="w-full max-w-7xl px-6 mb-6 grid grid-cols-1 md:grid-cols-3 gap-4 fade-slide">
  <div class="flex gap-3 items-center glass p-3 rounded-xl shadow-sm">
    <button id="toggleFilter" onclick="toggleFilter()"
      class="px-4 py-2 bg-gradient-to-r from-cyan-600 to-teal-600 hover:from-cyan-500 hover:to-teal-500 text-white font-medium rounded-lg shadow transition">
      Hide All Entries
    </button>
    <div class="flex items-center gap-2">
      <label for="limitInput" class="text-sm font-medium">Limit:</label>
      <input type="number" id="limitInput" min="1" max="999" value="300"
             onchange="updateLimit(this.value)"
             class="w-24 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 dark:bg-slate-800">
    </div>
  </div>
  <div class="md:col-span-2 glass p-3 rounded-xl shadow-sm flex items-center">
    <input type="text" id="searchInput" placeholder="ðŸ” Search any field..."
           class="w-full px-4 py-2 rounded-lg bg-transparent border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-cyan-500 outline-none placeholder-gray-400">
  </div>
</section>

<!-- STATS -->
<section class="w-full max-w-7xl grid grid-cols-1 sm:grid-cols-3 gap-6 px-6 fade-slide">
  <div class="glass p-6 rounded-2xl shadow hover:shadow-lg transition transform hover:-translate-y-1 text-center">
    <p class="text-sm text-gray-500 dark:text-gray-400">Total Requests</p>
    <p id="totalRequests" class="text-3xl font-bold counter mt-2">0</p>
  </div>
  <div class="glass p-6 rounded-2xl shadow hover:shadow-lg transition transform hover:-translate-y-1 text-center">
    <p class="text-sm text-gray-500 dark:text-gray-400">Unique Countries</p>
    <p id="uniqueCountries" class="text-3xl font-bold counter mt-2">0</p>
  </div>
  <div class="glass p-6 rounded-2xl shadow hover:shadow-lg transition transform hover:-translate-y-1 text-center">
    <p class="text-sm text-gray-500 dark:text-gray-400">Unique IPs</p>
    <p id="uniqueIPs" class="text-3xl font-bold counter mt-2">0</p>
  </div>
</section>

<!-- CHARTS -->
<section class="w-full max-w-7xl grid grid-cols-1 md:grid-cols-2 gap-6 mt-10 px-6 fade-slide">
  <div class="glass p-6 rounded-2xl shadow">
    <h2 class="text-lg font-semibold mb-3">Requests by Country</h2>
    <canvas id="countryChart" height="200"></canvas>
  </div>
  <div class="glass p-6 rounded-2xl shadow">
    <h2 class="text-lg font-semibold mb-3">Requests Over Time (Last 24h)</h2>
    <canvas id="timeChart" height="200"></canvas>
  </div>
</section>

<!-- MAIN TABLE -->
<main class="w-full max-w-7xl mt-8 px-6 flex-1 flex flex-col fade-slide">
  <div class="glass rounded-2xl shadow-lg overflow-hidden">
    <div class="overflow-x-auto">
      <table id="logsTable" class="w-full text-sm border-collapse">
        <thead class="bg-gradient-to-r from-cyan-600 to-indigo-600 dark:from-cyan-700 dark:to-indigo-700 text-white sticky top-0 shadow-md text-left">
          <tr>
            <th class="px-4 py-3 font-medium">#</th>
            <th class="px-4 py-3 font-medium">Timestamp</th>
            <th class="px-4 py-3 font-medium">Country</th>
            <th class="px-4 py-3 font-medium">Region</th>
            <th class="px-4 py-3 font-medium">City</th>
            <th class="px-4 py-3 font-medium">Method</th>
            <th class="px-4 py-3 font-medium">Tool</th>
            <th class="px-4 py-3 font-medium">IP</th>
            <th class="px-4 py-3 font-medium">Request URL</th>
          </tr>
        </thead>
        <tbody id="logsTableBody" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
      </table>
    </div>
    <div id="loadingSpinner" class="hidden flex justify-center items-center py-8">
      <div class="w-10 h-10 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin"></div>
    </div>
  </div>
</main>

<!-- FIREBASE + JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.1/firebase-app-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.1/firebase-firestore-compat.js"></script>
<script>
let LIMITNUMBER = 300;
let unsubscribe = null;
let db;
let stats = { total:0, countries:new Set(), ips:new Set() };
let allData = [];

let countryChart, timeChart;

try {
  const firebaseConfig = {
    apiKey: "AIzaSyApaZD_ekJMAsWE8vvIJ3ie9l6m44_UomA",
    authDomain: "jsservice-data2.firebaseapp.com",
    projectId: "jsservice-data2",
    storageBucket: "jsservice-data2.firebasestorage.app",
    messagingSenderId: "1033348246763",
    appId: "1:1033348246763:web:817401b9ac969b323ba2ae",
  };
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
} catch (err) { showError("Firebase init error: " + err.message); }

function showError(msg){
  const e=document.getElementById("errorMessage");
  e.textContent=msg; e.classList.remove("hidden");
  setTimeout(()=>e.classList.add("hidden"),4000);
}

function createTableRow(doc,index){
  const d=doc.data();
  return `
    <tr class="fade-slide hover:bg-cyan-50 dark:hover:bg-slate-800 transition">
      <td class="px-4 py-2">${index}</td>
      <td class="px-4 py-2">${d.timestamp||"N/A"}</td>
      <td class="px-4 py-2">${d.country||"N/A"}</td>
      <td class="px-4 py-2">${d.regionName||"N/A"}</td>
      <td class="px-4 py-2">${d.city||"N/A"}</td>
      <td class="px-4 py-2">${d.method||"N/A"}</td>
      <td class="px-4 py-2">${d.source||"N/A"}</td>
      <td class="px-4 py-2">${d.ip||"N/A"}</td>
      <td class="px-4 py-2 truncate" title="${d.url}">${d.url||"N/A"}</td>
    </tr>`;
}

function animateCounter(el,newValue){
  const current=parseInt(el.textContent)||0;
  const diff=newValue-current;
  if(diff===0) return;
  const step=Math.ceil(Math.abs(diff)/20);
  let count=current;
  const interval=setInterval(()=>{
    count+=(diff>0? step:-step);
    if((diff>0&&count>=newValue)||(diff<0&&count<=newValue)){count=newValue;clearInterval(interval);}
    el.textContent=count;
  },20);
}

function updateLimit(value){
  const n=parseInt(value);
  if(n>0&&n<1000){
    LIMITNUMBER=n;
    if(unsubscribe) unsubscribe();
    document.getElementById("logsTableBody").innerHTML="";
    initializeFirestoreListener();
  }
}

function toggleFilter(){
  const btn=document.getElementById("toggleFilter");
  const rows=document.querySelectorAll("tr[data-url='/mine/list']");
  const showingAll=btn.textContent.includes("Hide");
  rows.forEach(r=>r.classList.toggle("hidden",showingAll));
  btn.textContent=showingAll?"Show All Entries":"Hide All Entries";
}

function applySearch(){
  const term=document.getElementById("searchInput").value.toLowerCase();
  const body=document.getElementById("logsTableBody");
  body.innerHTML="";
  let idx=0;
  allData.forEach(doc=>{
    const d=doc.data();
    const combined=`${d.timestamp||''} ${d.country||''} ${d.regionName||''} ${d.city||''} ${d.method||''} ${d.source||''} ${d.ip||''} ${d.url||''}`.toLowerCase();
    if(combined.includes(term)){
      idx++; body.insertAdjacentHTML("beforeend", createTableRow(doc, idx));
    }
  });
}
document.getElementById("searchInput").addEventListener("input", applySearch);

// Chart.js setup
function initCharts(){
  const ctx1=document.getElementById("countryChart");
  const ctx2=document.getElementById("timeChart");

  countryChart=new Chart(ctx1,{
    type:'bar',
    data:{labels:[],datasets:[{label:'Requests',data:[],backgroundColor:'rgba(6,182,212,0.7)',borderRadius:6}]},
    options:{scales:{y:{beginAtZero:true,ticks:{color:'#888'}},x:{ticks:{color:'#888'}}},plugins:{legend:{display:false}}}
  });

  timeChart=new Chart(ctx2,{
    type:'line',
    data:{labels:[],datasets:[{label:'Requests',data:[],borderColor:'#06b6d4',tension:0.3,fill:false}]},
    options:{scales:{y:{beginAtZero:true,ticks:{color:'#888'}},x:{ticks:{color:'#888'}}},plugins:{legend:{display:false}}}
  });
}

function updateCharts(docs){
  const countryCounts={};
  const timeCounts={};

  docs.forEach(doc=>{
    const d=doc.data();
    if(d.country) countryCounts[d.country]=(countryCounts[d.country]||0)+1;
    if(d.timestamp){
      const hour=d.timestamp.toString().slice(0,13);
      timeCounts[hour]=(timeCounts[hour]||0)+1;
    }
  });

  const topCountries=Object.entries(countryCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
  countryChart.data.labels=topCountries.map(c=>c[0]);
  countryChart.data.datasets[0].data=topCountries.map(c=>c[1]);
  countryChart.update();

  const sortedTimes=Object.entries(timeCounts).sort();
  timeChart.data.labels=sortedTimes.map(t=>t[0]);
  timeChart.data.datasets[0].data=sortedTimes.map(t=>t[1]);
  timeChart.update();
}

function initializeFirestoreListener(){
  const spinner=document.getElementById("loadingSpinner");
  spinner.classList.remove("hidden");

  unsubscribe=db.collection("requests")
    .orderBy("timestamp","desc")
    .limit(LIMITNUMBER)
    .onSnapshot(snapshot=>{
      spinner.classList.add("hidden");
      const body=document.getElementById("logsTableBody");
      allData=snapshot.docs;
      body.innerHTML="";
      stats={total:0,countries:new Set(),ips:new Set()};
      let idx=0;
      snapshot.forEach(doc=>{
        const d=doc.data();
        if(d.country) stats.countries.add(d.country);
        if(d.ip) stats.ips.add(d.ip);
        stats.total++;
        idx++;
        body.insertAdjacentHTML("beforeend", createTableRow(doc, idx));
      });
      animateCounter(document.getElementById("totalRequests"), stats.total);
      animateCounter(document.getElementById("uniqueCountries"), stats.countries.size);
      animateCounter(document.getElementById("uniqueIPs"), stats.ips.size);
      updateCharts(snapshot.docs);
    },err=>{
      spinner.classList.add("hidden");
      showError(err.message);
    });
}

initCharts();
initializeFirestoreListener();
document.getElementById("toggleDark").addEventListener("click",()=>document.documentElement.classList.toggle("dark"));
</script>
</body>
</html>
