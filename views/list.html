<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Firestore Logs Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.1/firebase-app-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.1/firebase-firestore-compat.js"></script>
  </head>

  <body class="bg-slate-50 min-h-screen flex flex-col items-center p-6">
    <!-- HEADER -->
    <header class="w-full max-w-7xl mb-6 flex justify-between items-center">
      <h1 class="text-2xl font-semibold text-slate-800">
        Firestore Request Logs
      </h1>
      <div
        id="errorMessage"
        class="hidden bg-red-100 text-red-700 px-4 py-2 rounded shadow text-sm"
      ></div>
    </header>

    <!-- CONTROLS -->
    <section
      class="w-full max-w-7xl bg-white rounded-xl shadow p-4 mb-6 flex flex-wrap gap-3 items-center justify-between"
    >
      <div class="flex gap-3 items-center">
        <button
          id="toggleFilter"
          onclick="toggleFilter()"
          class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-medium transition"
        >
          Hide '/mine/list' Entries
        </button>

        <div class="flex items-center gap-2">
          <label for="limitInput" class="text-sm font-medium text-slate-700">
            Limit:
          </label>
          <input
            type="number"
            id="limitInput"
            min="1"
            max="999"
            value="300"
            onchange="updateLimit(this.value)"
            class="w-24 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500"
          />
        </div>
      </div>

      <!-- PAGINATION -->
      <div class="flex items-center gap-1">
        <button
          onclick="changePage('first')"
          class="px-3 py-2 text-slate-700 hover:bg-slate-100 rounded-lg"
        >
          ⏮
        </button>
        <button
          onclick="changePage('prev')"
          class="px-3 py-2 text-slate-700 hover:bg-slate-100 rounded-lg"
        >
          ◀
        </button>
        <span id="pageIndicator" class="px-3 text-slate-600 font-medium">1</span>
        <button
          onclick="changePage('next')"
          class="px-3 py-2 text-slate-700 hover:bg-slate-100 rounded-lg"
        >
          ▶
        </button>
        <button
          onclick="changePage('last')"
          class="px-3 py-2 text-slate-700 hover:bg-slate-100 rounded-lg"
        >
          ⏭
        </button>
      </div>
    </section>

    <!-- TABLE -->
    <main
      class="w-full max-w-7xl bg-white rounded-xl shadow overflow-hidden flex-1 flex flex-col"
    >
      <div class="overflow-x-auto">
        <table class="w-full text-sm text-left text-slate-700">
          <thead class="bg-emerald-600 text-white sticky top-0">
            <tr>
              <th class="px-3 py-3">#</th>
              <th class="px-3 py-3">Timestamp</th>
              <th class="px-3 py-3">Country</th>
              <th class="px-3 py-3">Region</th>
              <th class="px-3 py-3">City</th>
              <th class="px-3 py-3">Method</th>
              <th class="px-3 py-3">Tool</th>
              <th class="px-3 py-3">IP</th>
              <th class="px-3 py-3">Request URL</th>
            </tr>
          </thead>
          <tbody id="logsTableBody" class="divide-y divide-slate-100"></tbody>
        </table>
      </div>

      <!-- LOADING SPINNER -->
      <div
        id="loadingSpinner"
        class="hidden flex justify-center items-center py-8"
      >
        <div
          class="w-8 h-8 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"
        ></div>
      </div>
    </main>

    <script>
      let LIMITNUMBER = 300;
      let unsubscribe = null;
      let currentPage = 1;
      let lastKnownDoc = null;
      let firstVisibleDoc = null;
      let totalDocuments = 0;
      let db;

      // Firebase initialization
      try {
        const firebaseConfig = {
          apiKey: "AIzaSyApaZD_ekJMAsWE8vvIJ3ie9l6m44_UomA",
          authDomain: "jsservice-data2.firebaseapp.com",
          projectId: "jsservice-data2",
          storageBucket: "jsservice-data2.firebasestorage.app",
          messagingSenderId: "1033348246763",
          appId: "1:1033348246763:web:817401b9ac969b323ba2ae",
          measurementId: "G-VKYK1QTZ81",
        };
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        console.log("Firebase initialized successfully");
      } catch (err) {
        showError("Firebase initialization failed: " + err.message);
      }

      function showError(message) {
        const errorDiv = document.getElementById("errorMessage");
        errorDiv.textContent = message;
        errorDiv.classList.remove("hidden");
        setTimeout(() => errorDiv.classList.add("hidden"), 4000);
      }

      function createTableRow(doc, index) {
        const data = doc.data();
        const isFilteredOut = data.url === "/mine/list";
        const rowClass = isFilteredOut ? "hidden" : "";
        return `
          <tr class="${rowClass} hover:bg-slate-50 transition" data-url="${data.url}" data-id="${doc.id}">
            <td class="px-3 py-2">${index}</td>
            <td class="px-3 py-2">${data.timestamp || "N/A"}</td>
            <td class="px-3 py-2">${data.country || "N/A"}</td>
            <td class="px-3 py-2">${data.regionName || "N/A"}</td>
            <td class="px-3 py-2">${data.city || "N/A"}</td>
            <td class="px-3 py-2">${data.method || "N/A"}</td>
            <td class="px-3 py-2">${data.source || "N/A"}</td>
            <td class="px-3 py-2">${data.ip || "N/A"}</td>
            <td class="px-3 py-2 truncate max-w-[250px]" title="${data.url}">
              ${data.url || "N/A"}
            </td>
          </tr>
        `;
      }

      function updateLimit(value) {
        const newLimit = parseInt(value);
        if (newLimit > 0 && newLimit < 1000) {
          LIMITNUMBER = newLimit;
          if (unsubscribe) unsubscribe();
          document.getElementById("logsTableBody").innerHTML = "";
          initializeFirestoreListener();
        }
      }

      function initializeFirestoreListener() {
        const spinner = document.getElementById("loadingSpinner");
        spinner.classList.remove("hidden");
        unsubscribe = db
          .collection("requests")
          .orderBy("timestamp", "desc")
          .limit(LIMITNUMBER)
          .onSnapshot(
            (snapshot) => {
              spinner.classList.add("hidden");
              const tableBody = document.getElementById("logsTableBody");
              tableBody.innerHTML = "";
              let index = 0;
              snapshot.forEach((doc) => {
                index++;
                const newRow = createTableRow(doc, index);
                tableBody.insertAdjacentHTML("beforeend", newRow);
              });
            },
            (error) => {
              spinner.classList.add("hidden");
              showError("Error loading data: " + error.message);
            }
          );
      }

      function toggleFilter() {
        const btn = document.getElementById("toggleFilter");
        const rows = document.querySelectorAll("tr[data-url='/mine/list']");
        const showingAll = btn.textContent.includes("Hide");
        rows.forEach((r) => r.classList.toggle("hidden", showingAll));
        btn.textContent = showingAll
          ? "Show All Entries"
          : "Hide '/mine/list' Entries";
        btn.classList.toggle("bg-emerald-600");
        btn.classList.toggle("bg-red-600");
      }

      // Initialize
      initializeFirestoreListener();
    </script>
  </body>
</html>
