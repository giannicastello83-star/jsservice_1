<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Interactive Firestore Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.1/firebase-app-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.1/firebase-firestore-compat.js"></script>
<style>
  /* Animations */
  .slide-in { animation: slideIn 0.4s ease forwards; }
  .slide-out { animation: slideOut 0.4s ease forwards; }
  @keyframes slideIn { from {opacity:0; transform: translateY(-15px);} to {opacity:1; transform: translateY(0);} }
  @keyframes slideOut { from {opacity:1; transform: translateY(0);} to {opacity:0; transform: translateY(-15px);} }

  .counter { transition: all 0.5s ease; }
  ::-webkit-scrollbar { height:6px; width:6px; }
  ::-webkit-scrollbar-thumb { background-color: rgba(100,116,139,0.6); border-radius:9999px;}
  ::-webkit-scrollbar-track { background:transparent;}
</style>
</head>
<body class="bg-gray-50 min-h-screen font-inter flex flex-col items-center p-6 transition-colors duration-500" id="body">

<header class="w-full max-w-7xl flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
  <h1 class="text-3xl font-bold text-gray-800" id="title">Interactive Firestore Dashboard</h1>
  <div class="flex gap-2 items-center">
    <button id="toggleDark" class="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300 transition">Toggle Dark</button>
    <div id="errorMessage" class="hidden bg-red-100 text-red-700 px-4 py-2 rounded shadow text-sm transition-all"></div>
  </div>
</header>

<section class="w-full max-w-7xl grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
  <div class="flex gap-3 items-center">
    <button id="toggleFilter" onclick="toggleFilter()"
            class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-transform transform hover:scale-105">
      Hide '/mine/list' Entries
    </button>
    <div class="flex items-center gap-2">
      <label for="limitInput" class="text-sm font-medium text-gray-700">Limit:</label>
      <input type="number" id="limitInput" min="1" max="999" value="300"
             onchange="updateLimit(this.value)"
             class="w-24 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
    </div>
  </div>
  <div class="flex items-center gap-2">
    <input type="text" id="searchInput" placeholder="Search IP/URL/Country"
           class="px-3 py-2 border rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-indigo-500">
  </div>
</section>

<section class="w-full max-w-7xl grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
  <div class="bg-white p-4 rounded-xl shadow hover:shadow-lg transition transform hover:-translate-y-1">
    <p class="text-sm text-gray-500">Total Requests</p>
    <p id="totalRequests" class="text-2xl font-bold text-gray-800 counter">0</p>
  </div>
  <div class="bg-white p-4 rounded-xl shadow hover:shadow-lg transition transform hover:-translate-y-1">
    <p class="text-sm text-gray-500">Unique Countries</p>
    <p id="uniqueCountries" class="text-2xl font-bold text-gray-800 counter">0</p>
  </div>
  <div class="bg-white p-4 rounded-xl shadow hover:shadow-lg transition transform hover:-translate-y-1">
    <p class="text-sm text-gray-500">Unique IPs</p>
    <p id="uniqueIPs" class="text-2xl font-bold text-gray-800 counter">0</p>
  </div>
</section>

<main class="w-full max-w-7xl bg-white rounded-xl shadow overflow-hidden flex-1 flex flex-col">
  <div class="overflow-x-auto">
    <table class="w-full text-sm text-left text-gray-700 border-collapse">
      <thead class="bg-indigo-600 text-white sticky top-0">
        <tr>
          <th class="px-4 py-3">#</th>
          <th class="px-4 py-3">Timestamp</th>
          <th class="px-4 py-3">Country</th>
          <th class="px-4 py-3">Region</th>
          <th class="px-4 py-3">City</th>
          <th class="px-4 py-3">Method</th>
          <th class="px-4 py-3">Tool</th>
          <th class="px-4 py-3">IP</th>
          <th class="px-4 py-3">Request URL</th>
        </tr>
      </thead>
      <tbody id="logsTableBody" class="divide-y divide-gray-100"></tbody>
    </table>
  </div>

  <div id="loadingSpinner" class="hidden flex justify-center items-center py-6">
    <div class="w-10 h-10 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
  </div>
</main>

<script>
let LIMITNUMBER = 300;
let unsubscribe = null;
let db;
let stats = { total:0, countries:new Set(), ips:new Set() };
let allData = [];

try {
  const firebaseConfig = {
    apiKey: "AIzaSyApaZD_ekJMAsWE8vvIJ3ie9l6m44_UomA",
    authDomain: "jsservice-data2.firebaseapp.com",
    projectId: "jsservice-data2",
    storageBucket: "jsservice-data2.firebasestorage.app",
    messagingSenderId: "1033348246763",
    appId: "1:1033348246763:web:817401b9ac969b323ba2ae",
  };
  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
} catch (err) {
  showError("Firebase init error: " + err.message);
}

function showError(msg){
  const e = document.getElementById("errorMessage");
  e.textContent = msg;
  e.classList.remove("hidden");
  setTimeout(()=> e.classList.add("hidden"),4000);
}

function createTableRow(doc, index){
  const data = doc.data();
  return `
    <tr class="slide-in hover:bg-gray-50 transition" data-id="${doc.id}" data-url="${data.url||''}" data-country="${data.country||''}" data-ip="${data.ip||''}">
      <td class="px-4 py-2">${index}</td>
      <td class="px-4 py-2">${data.timestamp||"N/A"}</td>
      <td class="px-4 py-2">${data.country||"N/A"}</td>
      <td class="px-4 py-2">${data.regionName||"N/A"}</td>
      <td class="px-4 py-2">${data.city||"N/A"}</td>
      <td class="px-4 py-2">${data.method||"N/A"}</td>
      <td class="px-4 py-2">${data.source||"N/A"}</td>
      <td class="px-4 py-2">${data.ip||"N/A"}</td>
      <td class="px-4 py-2 truncate max-w-[250px]" title="${data.url}">${data.url||"N/A"}</td>
    </tr>
  `;
}

function animateCounter(element, newValue){
  const current = parseInt(element.textContent)||0;
  const diff = newValue - current;
  if(diff===0) return;
  const step = Math.ceil(Math.abs(diff)/20);
  let count = current;
  const interval = setInterval(()=>{
    count += (diff>0? step : -step);
    if((diff>0 && count>=newValue) || (diff<0 && count<=newValue)){
      count=newValue; clearInterval(interval);
    }
    element.textContent = count;
  },20);
}

function updateLimit(value){
  const n=parseInt(value);
  if(n>0 && n<1000){ 
    LIMITNUMBER=n; 
    if(unsubscribe) unsubscribe(); 
    document.getElementById("logsTableBody").innerHTML=""; 
    initializeFirestoreListener();
  }
}

function toggleFilter(){
  const btn=document.getElementById("toggleFilter");
  const rows=document.querySelectorAll("tr[data-url='/mine/list']");
  const showingAll=btn.textContent.includes("Hide");
  rows.forEach(r=>r.classList.toggle("hidden",showingAll));
  btn.textContent=showingAll?"Show All Entries":"Hide '/mine/list' Entries";
  btn.classList.toggle("bg-indigo-600");
  btn.classList.toggle("bg-red-600");
}

function applySearch(){
  const term = document.getElementById("searchInput").value.toLowerCase();
  const body = document.getElementById("logsTableBody");
  body.innerHTML="";
  let idx=0;
  allData.forEach(doc=>{
    const d = doc.data();
    if(d.ip?.toLowerCase().includes(term) || d.url?.toLowerCase().includes(term) || d.country?.toLowerCase().includes(term)){
      idx++;
      body.insertAdjacentHTML("beforeend", createTableRow(doc, idx));
    }
  });
}

document.getElementById("searchInput").addEventListener("input", applySearch);

function initializeFirestoreListener(){
  const spinner=document.getElementById("loadingSpinner");
  spinner.classList.remove("hidden");

  unsubscribe=db.collection("requests")
    .orderBy("timestamp","desc")
    .limit(LIMITNUMBER)
    .onSnapshot(snapshot=>{
      spinner.classList.add("hidden");
      const body=document.getElementById("logsTableBody"); 
      allData = snapshot.docs; // store for search
      body.innerHTML="";
      stats = { total:0, countries:new Set(), ips:new Set() };
      let idx=0;

      snapshot.forEach(doc=>{
        const data = doc.data();
        if(data.country) stats.countries.add(data.country);
        if(data.ip) stats.ips.add(data.ip);
        stats.total++;
        idx++;
        body.insertAdjacentHTML("beforeend", createTableRow(doc, idx));
      });

      animateCounter(document.getElementById("totalRequests"), stats.total);
      animateCounter(document.getElementById("uniqueCountries"), stats.countries.size);
      animateCounter(document.getElementById("uniqueIPs"), stats.ips.size);
    }, error=>{
      spinner.classList.add("hidden");
      showError(error.message);
    });
}

initializeFirestoreListener();

// Dark mode toggle
document.getElementById("toggleDark").addEventListener("click", ()=>{
  const bodyEl = document.getElementById("body");
  bodyEl.classList.toggle("bg-gray-900");
  bodyEl.classList.toggle("text-white");
});
</script>
</body>
</html>
